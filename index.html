<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MindAR Video AR</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />

  <!-- A-Frame + MindAR -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    :root {
      --btn-blue: #1e5df8; /* your requested colour */
    }

    /* Reset / base */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: Arial, sans-serif;
      background: #000;
    }

    /* ===== Overlay UI Container (rotates as one unit) ===== */
    #ar-ui {
      position: fixed;
      inset: 0;               /* full viewport */
      z-index: 2;          /* above AR scene */
      transform-origin: center center;
      transition: transform 0.25s ease;
      pointer-events: none;   /* let children opt-in */
    }

    /* ===== Play/Pause Button ===== */
    .btn {
      position: absolute;     /* position within #ar-ui */
      bottom: 20px;
      left: 20px;
      width: 70px;
      height: 70px;
      background: var(--btn-blue);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      user-select: none;
      pointer-events: auto;   /* clickable */
      box-shadow: 0 8px 24px rgba(30, 93, 248, 0.35);
      transition: transform 0.1s ease, box-shadow 0.2s ease;
      touch-action: manipulation;
    }
    .btn:active { transform: scale(0.96); }

    .btn svg {
      width: 34px;
      height: 34px;
      fill: #fff;   /* white icon */
      display: block;
    }

    /* ===== Close Button (kept compact) ===== */
    #closeBtn {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 55px;
      height: 55px;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 26px;
      line-height: 1;
      cursor: pointer;
      z-index: 10;
      pointer-events: auto;
      touch-action: manipulation;
    }

    /* ===== Audio Overlay (tap to enable sound) ===== */
    #audioOverlay {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      color: white;
      display: none; /* shown on load, hidden after first tap */
      align-items: center;
      justify-content: center;
      font-size: 22px;
      text-align: center;
      z-index: 20;
      cursor: pointer;
      pointer-events: auto;
      padding: 24px;
    }
    /* Improve legibility on small screens */
    @media (max-width: 420px) {
      .btn { width: 62px; height: 62px; }
      .btn svg { width: 28px; height: 28px; }
      #closeBtn { width: 48px; height: 48px; font-size: 22px; }
      #audioOverlay { font-size: 18px; }
    }
  </style>
</head>

<body>

  <!-- ===== AR Scene ===== -->
  <a-scene
    mindar-image="imageTargetSrc: targets.mind; filterMinCF: 0.0001; filterBeta: 0.001;"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: true"
  >
    <a-assets>
      <video id="videoAsset"
             src="video.mp4"
             preload="auto"
             loop
             crossorigin="anonymous"
             playsinline>
      </video>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <a-entity mindar-image-target="targetIndex: 0" id="target">
      <a-video id="arVideo"
               src="#videoAsset"
               width="1.6"
               height="0.9"
               position="0 0 0"
               visible="false">
      </a-video>
    </a-entity>
  </a-scene>

  <!-- ===== Overlay UI (rotates together) ===== -->
  <div id="ar-ui" aria-live="polite">
    <!-- Play/Pause Button with inline SVG icons -->
    <div id="togglePlayPauseBtn" class="btn" role="button" aria-label="Play video" aria-pressed="false">
      <!-- PLAY ICON (default) -->
      <svg id="iconPlay" viewBox="0 0 100 100" aria-hidden="true" focusable="false">
        <!-- Triangle -->
        <polygon points="30,20 80,50 30,80"></polygon>
      </svg>
      <!-- PAUSE ICON (hidden initially) -->
      <svg id="iconPause" viewBox="0 0 100 100" style="display:none;" aria-hidden="true" focusable="false">
        <!-- Two bars -->
        <rect x="25" y="20" width="18" height="60"></rect>
        <rect x="57" y="20" width="18" height="60"></rect>
      </svg>
    </div>

    <!-- Close Button -->
    <div id="closeBtn" role="button" aria-label="Close video">âœ•</div>

    <!-- Audio Unlock Overlay -->
    <div id="audioOverlay">Tap to Enable Sound</div>
  </div>

  <script>
    window.onload = () => {
      // Elements
      const video = document.querySelector('#videoAsset');
      const videoEntity = document.querySelector('#arVideo');
      const target = document.querySelector('#target');

      const uiWrapper = document.getElementById('ar-ui');
      const toggleBtn = document.getElementById('togglePlayPauseBtn');
      const iconPlay = document.getElementById('iconPlay');
      const iconPause = document.getElementById('iconPause');
      const closeBtn = document.getElementById('closeBtn');
      const audioOverlay = document.getElementById('audioOverlay');

      // Scale factor for AR plane (kept from your original)
      const scaleMultiplier = 0.65;
      videoEntity.object3D.scale.set(scaleMultiplier, scaleMultiplier, scaleMultiplier);

      // Show the audio overlay on load to ensure user gesture before unmuted playback
      audioOverlay.style.display = 'flex';

      // --- UI: Play/Pause icon swap ---
      function updateToggleBtn() {
        const isPaused = video.paused;
        iconPlay.style.display = isPaused ? 'block' : 'none';
        iconPause.style.display = isPaused ? 'none' : 'block';
        toggleBtn.setAttribute('aria-label', isPaused ? 'Play video' : 'Pause video');
        toggleBtn.setAttribute('aria-pressed', String(!isPaused));
      }

      // --- Orientation handling (counter-rotate to keep UI upright) ---
      function computeRotationAngle() {
        // Map device angle to counter-rotation so UI stays visually upright.
        // Adjust mapping if your browser/device behaves differently.
        if (screen.orientation && typeof screen.orientation.angle === 'number') {
          const a = screen.orientation.angle % 360; // 0, 90, 180, 270
          if (a === 0)   return 0;
          if (a === 90)  return -90;
          if (a === 180) return 180;
          if (a === 270) return 90;
        } else if (typeof window.orientation === 'number') {
          // iOS Safari legacy: 0, 90, -90, 180
          const o = window.orientation;
          if (o === 0)   return 0;
          if (o === 90)  return -90;
          if (o === -90) return 90;
          if (o === 180) return 180;
        }
        return 0;
      }

      function rotateUI() {
        const angle = computeRotationAngle();
        uiWrapper.style.transform = `rotate(${angle}deg)`;
      }

      // Initial state
      rotateUI();
      updateToggleBtn();

      // Listeners: orientation
      window.addEventListener('orientationchange', rotateUI);
      if (screen.orientation && typeof screen.orientation.addEventListener === 'function') {
        screen.orientation.addEventListener('change', rotateUI);
      }

      // Audio unlock overlay
      audioOverlay.addEventListener('click', () => {
        // User gesture: allow unmuted playback
        video.muted = false;
        // Prime the video (some devices require a play call first)
        video.play().then(() => {
          video.pause();
          audioOverlay.style.display = 'none';
        }).catch(() => {
          // If play() fails (e.g., blocked), still hide overlay to allow controls
          audioOverlay.style.display = 'none';
        });
      }, { passive: true });

      // Play/Pause toggle
      toggleBtn.addEventListener('click', () => {
        if (video.paused) {
          video.play().catch(() => {/* ignore */});
        } else {
          video.pause();
        }
        updateToggleBtn();
      }, { passive: true });

      // Close: stop and hide video
      closeBtn.addEventListener('click', () => {
        video.pause();
        video.currentTime = 0;
        videoEntity.object3D.visible = false;
        updateToggleBtn();
      }, { passive: true });

      // MindAR target events
      target.addEventListener('targetFound', () => {
        videoEntity.object3D.visible = true;
        // Attempt playback (will succeed after audio overlay tap)
        video.play().catch(() => {/* ignore until user gesture */});
        updateToggleBtn();
      });

      target.addEventListener('targetLost', () => {
        video.pause();
        updateToggleBtn();
      });
    };
  </script>
</body>
</html>
